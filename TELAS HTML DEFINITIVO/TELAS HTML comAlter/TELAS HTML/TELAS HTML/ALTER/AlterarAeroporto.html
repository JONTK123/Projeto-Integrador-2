<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alterar Aeroporto</title>
    <script>

      function RequisiçãoGETcidade() {
        const requestOptions = {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
        };
        return fetch('http://localhost:3000/listarCidades', requestOptions)
          .then(T => T.json());
      }

      function preencherSelectCidades(options) {
        const cidadeSelect = document.getElementById('cidade');

        options.forEach(optionValue => {
          console.log("Código Cidade: " + JSON.stringify(optionValue));
          const option = document.createElement('option');
          option.value = optionValue.codigo;  // Definindo o valor corretamente
          option.innerHTML = optionValue.nome;  // Definindo o texto do option
          cidadeSelect.appendChild(option);
        });
      }

      function exibirCidades() {
        console.log('Entrou no exibir...');
        RequisiçãoGETcidade()
          .then(customResponse => {
            if (customResponse.status === "SUCCESS") {
              console.log("Deu certo a busca de dados");
              console.log('Payload:' + JSON.stringify(customResponse.payload));
              preencherSelectCidades(customResponse.payload); // Removido o parse redundante
            } else {
              console.log(customResponse.message);
            }
          })
          .catch((e) => {
            console.log("Não foi possível exibir." + e);
          });
      }


      function nomePreenchido(){
        const nome = document.getElementById("nome").value.trim();
        return nome.length > 0;
      }

      function siglaPreenchida(){
        const sigla = document.getElementById("sigla").value.trim();
        return sigla.length > 0;
      }

      function fetchAlterar(body) {
        const requestOptions = {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        };

        return fetch('http://localhost:3000/alterarAeroporto', requestOptions)
            .then(response => response.json());
        }

      function alterarAeroporto(){

        if(!nomePreenchido()){
          showStatusMessage("Preencha o nome do aeroporto.", true);
          return;
        }

        if(!siglaPreenchida()){
          showStatusMessage("Preencha a sigla do aeroporto.", true);
          return;
        }

        const nome = document.getElementById("nome").value;
        const sigla = document.getElementById("sigla").value;
        const cidade = document.getElementById("cidade").options[document.getElementById("cidade").selectedIndex].value;
        const codigo = document.getElementById("codigo").value;
        
        fetchAlterar({ 
            nome: nome, 
            sigla: sigla,
            cidade: cidade,
            codigo: codigo
        })
        .then(customResponse => {
          if(customResponse.status === "SUCCESS"){
            showStatusMessage("Aeroporto alterado com sucesso.", false);
          } else {
            showStatusMessage("Erro ao alterar aeroporto: " + customResponse.message, true);
            console.log(customResponse.message);
          }
        })
        .catch((e)=>{
          showStatusMessage("Erro técnico ao alterar... Contate o suporte.", true);
          console.log("Falha grave ao alterar." + e)
        });

      }

      function showStatusMessage(msg, error){
        var pStatus = document.getElementById("status");
        if (error === true){
          pStatus.className = "statusError";
        } else {
          pStatus.className = "statusSuccess";
        }
        pStatus.textContent = msg;
      }
    </script>
</head>
<body>
    <h1>Atualizar Aeroporto</h1>
    <p>
        Preencha todos os campos para alterar um aeroporto.
      </p>
      <form>
        <p>
          <label for="codigo">Código do aeroporto:</label><br/>
          <input type="number" id="codigo" name="codigo"/>
        </p>
        <p>
          <label for="nome">Nome do aeroporto:</label><br/>
          <input type="text" id="nome" name="nome"/>
        </p>
        <p>
          <label for="sigla">Sigla do aeroporto:</label><br/>
          <input type="text" id="sigla" name="sigla"/>
        </p>
        <p>
          <label for="cidade">Cidade do aeroporto:</label><br/>
          <select name="cidades" id="cidade">
            <script>
              exibirCidades();
            </script>
          </select>
        </p>
        <p>
          <button 
            type="button" 
            onclick="alterarAeroporto();"
            id="btnAlterar"
            name="btnAlterar">Alterar</button>
          <button type="reset">Limpar</button>
          <button 
            type="button"
            id="btnNext"
            name="btnNext"><a href="/INSERT/CadastrarTrecho.html">Next</a></button>
        </p>
        <p id="status" class="statusError"></p>
      </form>
</body>
</html>
