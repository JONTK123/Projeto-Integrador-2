<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alterar Voo</title>

    <script>

        function RequisiçãoGETtrecho() {
            const requestOptions = {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' },
            };
            return fetch('http://localhost:3000/listarTrechos', requestOptions)
              .then(T => T.json());
          }
        
        function preencherSelectTrechos(options) {
          const trechoSelect = document.getElementById('trecho');
        
          options.forEach(optionValue => {
            console.log("Código Trecho: " + JSON.stringify(optionValue));
            const option = document.createElement('option');
            option.value = optionValue.codigo;  // Definindo o valor corretamente
            option.innerHTML = optionValue.nome;  // Definindo o texto do option
            trechoSelect.appendChild(option);
          });
        }
        
        function exibirTrechos() {
          console.log('Entrou no exibir...');
          RequisiçãoGETtrecho()
            .then(customResponse => {
              if (customResponse.status === "SUCCESS") {
                console.log("Deu certo a busca de dados");
                console.log('Payload:' + JSON.stringify(customResponse.payload));
                preencherSelectTrechos(customResponse.payload); // Removido o parse redundante
              } else {
                console.log(customResponse.message);
              }
            })
            .catch((e) => {
              console.log("Não foi possível exibir." + e);
            });
        }
        
        function codigoValido() {
          let resultado = false;
          var strCodigo = document.getElementById("codigo").value;
          const codigo = parseInt(strCodigo);
        
          if (!isNaN(codigo) && codigo > 0) {
              resultado = true;
          }
          return resultado;
        }
        
        
        function valorValido() {
          let resultado = false;
          var strValor = document.getElementById("valor").value;
          const valor = parseInt(strValor);
        
          if (!isNaN(valor) && valor > 0) {
              resultado = true;
          }
          return resultado;
        }
        
        function trechoValido(){
          let resultado = false; 
          var listaTrechos = document.getElementById("trecho");
          var valorSelecionado = listaTrechos.value;
          if (valorSelecionado !== "0"){
            resultado = true;
          }
          return resultado;
        }
        
        function fetchAlterar(body) {
          const requestOptions = {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
          };
        
          return fetch('http://localhost:3000/alterarVoo', requestOptions)
              .then(response => response.json());
        }
        
        function alterarVoo() {
        
          if (!codigoValido()) {
              showStatusMessage("O código do voo deve ser um número válido.", true);
              return;
          }
        
          if(!valorValido()) {
            showStatusMessage("Digite um Valor maior que zero.")
            return;
          }
        
          if(!trechoValido()) {
            showStatusMessage("Digite um Valor maior que zero.")
            return;
          }
        
        
          const hrSaida = document.getElementById("hrSaida").value;
          const hrChegada = document.getElementById("hrChegada").value;
          const dataVoo = document.getElementById("dataVoo").value;
          const valor = document.getElementById("valor").value;
          const trecho = document.getElementById("trecho").options[document.getElementById("trecho").selectedIndex].value;
          const codigo = document.getElementById("codigo").value;        
          
          fetchAlterar({
              dataVoo: dataVoo,
              hrChegada: hrChegada,
              hrSaida: hrSaida,
              valor: valor,
              trecho: trecho,
              codigo: codigo
          })
              .then(customResponse => {
                  if (customResponse.status === "SUCCESS") {
                      showStatusMessage("Voo cadastrado com sucesso.", false);
                  } else {
                      showStatusMessage("Erro ao cadastrar voo: " + customResponse.message, true);
                      console.log(customResponse.message);
                  }
              })
              .catch((e) => {
                  showStatusMessage("Erro técnico ao cadastrar... Contate o suporte.", true);
                  console.log("Falha grave ao cadastrar." + e);
              });
        
        }
        
        function showStatusMessage(msg, error) {
          var pStatus = document.getElementById("status");
          if (error === true) {
              pStatus.className = "statusError";
          } else {
              pStatus.className = "statusSuccess";
          }
          pStatus.textContent = msg;
        }

    </script>
    <style>
        .statusError {
            color: red;
        }
        .statusSuccess {
            color: blue;
        }
    </style>
</head>
<body>
    <h1>Alterar Voo</h1>
    <p>
        Preencha todos os campos para alterar um voo.
    </p>
    <form>
        <p>
            <label for="codigo">Código do voo:</label><br/>
            <input type="number" id="codigo" name="codigo"/>
        </p>
        <p>
            <label for="dataVoo">Data:</label><br/>
            <input type="date" id="dataVoo" name="dataVoo"/>
        </p>
        <p>
            <label for="hrSaida">Hora de Saída:</label><br/>
            <input type="text" id="hrSaida" name="hrSaida"/>
        </p>
        <p>
            <label for="hrChegada">Hora de Chegada:</label><br/>
            <input type="text" id="hrChegada" name="hrChegada"/>
        </p>
        <p>
            <label for="valor">Valor:</label><br/>
            <input type="text" id="valor" name="valor"/>
        </p>
        <p>
            <label for="trecho">Trecho:</label><br/>
            <select name="trechos" id="trecho">
                <option value="0">Selecione o Trecho</option>
                <script>
                    exibirTrechos();
                </script>
            </select>
        </p>
        <p>  
            <button 
                type="button" 
                onclick="alterarVoo();"
                id="btnAlterar"
                name="btnAlterar">Alterar</button>
            <button type="reset">Limpar</button>
            <button 
                type="button"
                id="btnNext"
                name="btnNext"><a href="/TELAS HTML/TELAS HTML/SELECT/TabelaInicial.html">Sair</a></button>
        </p>
        <p id="status" class="statusError"></p>
    </form>
</body>
</html>
